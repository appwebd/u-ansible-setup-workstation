---
# Role: sysctl_conf
# Description: Setting sysctl configurations for the system
#
# 35543 - Ensure core dumps are restricted.
# TODO 35608 - Ensure ip forwarding is disabled.       FAILED?
# 35616 - Ensure suspicious packets are logged.
# 35542 - Ensure address space layout randomization is enabled.
# 35543 - Ensure core dumps are restricted.
# 35609 - Ensure packet redirect sending is disabled.
# 35610 - Ensure bogus icmp responses are ignored.
# 35611 - Ensure broadcast icmp requests are ignored.
# 35612 - Ensure icmp redirects are not accepted.
# 35613 - Ensure secure icmp redirects are not accepted.
# 35614 - Ensure reverse path filtering is enabled.
# 35615 - Ensure source routed packets are not accepted.
# 35617 - Ensure tcp syn cookies is enabled.
# 35618 - Ensure ipv6 router advertisements are not accepted.
#
# PROBLEM SOLVING
#
# Using the command
#     grep -rwn /etc/ -e 'net.ipv4.ip_forward'
#
# You will see the place WHERE that string is used, for example, in /etc/ufw.

- name: "Create file /etc/sysctl.conf"
  ansible.builtin.template:
    src: sysctl.conf.j2
    dest: /etc/sysctl.conf
    owner: root
    group: root
    mode: "0640"

# 1. Hard‑core limit
- name: "Ensure hard core limit is set in limits.d"
  ansible.builtin.lineinfile:
    path: "{{ wazuh_limits_file }}"
    regexp: '^\\*\\s+hard\\s+core'
    line: '* hard core 0'
    create: true
    mode: '0644'
  become: true

# 2. sysctl - fs.suid_dumpable = 0
- name: "Ensure /etc/sysctl.d/60-fs_sysctl.conf exists"
  ansible.builtin.copy:
    dest: "{{ wazuh_sysctl_file }}"
    content: "{{ wazuh_sysctl_content | trim }}\n"
    mode: '0644'
  become: true

# Apply the setting immediately (idempotent)
- name: "Set active kernel parameter fs.suid_dumpable"
  ansible.posix.sysctl:
    name: fs.suid_dumpable
    value: 0
    state: present
    reload: "{{ wazuh_sysctl_reload }}"
  become: true

# 3. Optional - systemd‑coredump configuration
- name: "Gather package facts (required for checking systemd-coredump)"
  ansible.builtin.package_facts:
    manager: auto
  become: false   # reading facts does not need sudo

- name: "Configure systemd-coredump if installed"
  when: "'systemd-coredump' in ansible_facts.packages"
  block:

    - name: "Ensure Storage=none line exists"
      ansible.builtin.lineinfile:
        path: /etc/systemd/coredump.conf
        regexp: '^Storage='
        line: "Storage={{ systemd_coredump_storage }}"
        create: true
        mode: '0644'
      notify: Reload systemd

    - name: "Ensure ProcessSizeMax=0 line exists"
      ansible.builtin.lineinfile:
        path: /etc/systemd/coredump.conf
        regexp: '^ProcessSizeMax='
        line: "ProcessSizeMax={{ systemd_coredump_process_size_max }}"
        create: true
        mode: '0644'
      notify: Reload systemd
